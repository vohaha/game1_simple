<%-
/**
 * Individual view page
 * Domain-accurate; shows Aggregate snapshot, traits, dynamic state, and event log.
 * Uses shared base layout and event_log partial. htmx-powered refresh for rapid feedback.
 * TODO: Add richer visualizations/context as domain evolves.
 */
-%>

<% const snapshot = individual.getSnapshot ? individual.getSnapshot() : individual.snapshot; %>

<section>
  <h1 class="text-2xl font-bold text-blue-900 mb-2">
    Individual: <span class="text-gray-700"><%= snapshot.name %></span>
    <span class="ml-2 text-xs bg-gray-100 border border-gray-300 rounded p-1 text-gray-500">#<%= snapshot.id %></span>
  </h1>

  <div class="my-4 grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Traits Table -->
    <div>
      <h2 class="text-lg font-semibold text-blue-700 mb-1">Traits</h2>
      <table class="min-w-full table-fixed border border-gray-200 rounded shadow bg-white">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-3 py-2 text-left font-medium text-gray-700">Key</th>
            <th class="px-3 py-2 text-left font-medium text-gray-700">Value</th>
          </tr>
        </thead>
        <tbody>
          <% (snapshot.traits || []).forEach(trait => { %>
            <tr>
              <td class="border-t px-3 py-2 font-mono"><%= trait.key %></td>
              <td class="border-t px-3 py-2"><%= trait.value %></td>
            </tr>
          <% }) %>
          <% if (!snapshot.traits || snapshot.traits.length === 0) { %>
            <tr>
              <td colspan="2" class="px-3 py-2 text-gray-400 italic">No traits defined.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    <!-- Dynamic State Table -->
    <div>
      <h2 class="text-lg font-semibold text-blue-700 mb-1">State</h2>
      <table class="min-w-full table-fixed border border-gray-200 rounded shadow bg-white">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-3 py-2 text-left font-medium text-gray-700">Key</th>
            <th class="px-3 py-2 text-left font-medium text-gray-700">Value</th>
          </tr>
        </thead>
        <tbody>
          <% Object.entries(snapshot.state || {}).forEach(([key, value]) => { %>
            <tr>
              <td class="border-t px-3 py-2 font-mono"><%= key %></td>
              <td class="border-t px-3 py-2"><%= JSON.stringify(value) %></td>
            </tr>
          <% }) %>
          <% if (!snapshot.state || Object.keys(snapshot.state).length === 0) { %>
            <tr>
              <td colspan="2" class="px-3 py-2 text-gray-400 italic">No dynamic state.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- HTMX-enabled state/event log refresh -->
<section class="my-8">
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-lg font-semibold text-blue-700">Activity Log</h2>
    <button
      class="px-3 py-1 rounded bg-blue-600 text-white text-xs font-semibold shadow hover:bg-blue-700 transition"
      hx-get="/htmx/individual/<%= snapshot.id %>/state"
      hx-target="#individual-eventlog"
      hx-trigger="click"
      hx-swap="outerHTML"
      title="Refresh activity/state"
      aria-label="Refresh"
    >
      Refresh
    </button>
  </div>
  <div id="individual-eventlog">
    <%-
      // Activity log partial: expects `events` array (filtered for this individual)
      include('../partials/event_log', { events: eventLog || [] })
    %>
  </div>
</section>
